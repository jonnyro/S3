---
version: 0.2

branches:
  default:
    stage: pre-merge
models:
  - env: &global_env
      CI: 'true'
      CIRCLE_ARTIFACTS: '/tmp'
      CIRCLE_NODE_TOTAL: "4"
      CIRCLE_TEST_REPORTS: '/tmp'
      CI_REPORTS: '/tmp'
      ENABLE_LOCAL_CACHE: "1"
      REPORT_TOKEN: 'report-token-1'
      REMOTE_MANAGEMENT_DISABLE: '1'
  - Git: &clone
      name: Pull repo
      repourl: '%(prop:git_reference)s'
      shallow: True
      retryFetch: True
      haltOnFailure: True
      # Machine Setup
  - ShellCommand: &update_hosts
      name: Update hosts
      command: sudo bash -c "echo '
               127.0.0.1     \
               bucketwebsitetester.s3-website-us-east-1.amazonaws.com
               ' >> /etc/hosts"
      haltOnFailure: True
  - ShellCommandWthSecrets: &aws-credentials
      name: Setup AWS Credentials
      command: bash eve/workers/build/aws.bash
      haltOnFailure: True
  - ShellCommandWithSecrets: &npm-install
      name: install modules
      command: npm install
      haltOnFailure: True
stages:
  pre-merge:
    worker: &master-worker
      type: docker
      path: eve/workers/build
      volumes: &default_volumes
        - '/home/eve/workspace'
    steps:
      - SetProperty:
          property: artifacts_name
          value: "scality-s3-%(prop:buildnumber)s"
          haltOnFailure: True
      - Git: *clone
      - ShellCommandWithSecrets: *npm-install
      - ShellCommandWithSecrets:
          name: Linting
          command: |
            npm run --silent lint -- --max-warnings 0
            npm run --silent lint_md
            flake8 $(git ls-files "*.py")
            yamllint $(git ls-files "*.yml")
      - ShellCommandWithSecrets:
          name: Unit Coverage
          command: |
            mkdir -p $CIRCLE_TEST_REPORTS/unit
            npm run unit_coverage
            npm run unit_coverage_legacy_location
          env: *global_env
          haltOnFailure: True
      - TriggerStages:
          name: Launch all nodes simultaneously
          stage_names:
            - external-backend-with-proxy
            - mongo-ft-tests
            - node0
            - node1
            - node2
            - node3
          waitForFinish: True
          haltOnFailure: True
  external-backend-with-proxy:
    worker:
      type: kube_pod
      path: eve/workers/pod.yaml
      images:
        aggressor: eve/workers/build
        s3: "."
      vars: &proxy-vars
        S3BACKEND: "mem"
        MPU_TESTING: "yes"
        S3DATA: "multiple"
        S3METADATA: ""
        CI_PROXY: "true"
    steps:
      - Git: *clone
      - ShellCommandWithSecrets: *aws-credentials
      - ShellCommand: *npm-install
      - ShellCommandWithSecrets:
          command: |
            set -ex
            . /root/.aws/exports &> /dev/null
            # npm start &
            bash wait_for_local_port.bash 8000 40
            npm run ft_awssdk_external_backends
            # kill -9 $(lsof -t -i:8000) || exit 1
          env:
            <<: *global_env
            <<: *proxy-vars
  mongo-ft-tests:
    worker:
      type: kube_pod
      path: eve/workers/pod.yaml
      images:
        aggressor: eve/workers/build
        s3: "."
      vars: &mongo-vars
        S3BACKEND: "mem"
        S3DATA: ""
        MPU_TESTING: "yes"
        S3METADATA: mongodb
        CI_PROXY: "false"
    steps:
      - Git: *clone
      - ShellCommandWithSecrets: *aws-credentials
      - ShellCommand: *npm-install
      - ShellCommandWithSecrets:
          command: |
            bash wait_for_local_port.bash 8000 40
            npm run ft_test
          env:
            <<: *global_env
            <<: *mongo-vars
  node0:
    worker: *master-worker
    steps:
      - Git: *clone
      - ShellCommand: *update_hosts
      - ShellCommand:
          command: rm -rf node_modules
      - ShellCommandWithSecrets: *aws-credentials
      - ShellCommandWithSecrets: *npm-install
      - ShellCommandWithSecrets:
          command: bash -l tests.bash
          timeout: 120
          env:
            <<: *global_env
            CIRCLE_NODE_INDEX: '0'
      - ShellCommand:
          name: prepare artifacts
          command: |
            mkdir -p artifacts/node0
            cp /tmp/*.txt artifacts/node0
      - Upload: &upload_artifacts
          source: artifacts
          urls:
            - "*"
  node1:
    worker: *master-worker
    steps:
      - Git: *clone
      - ShellCommand: *update_hosts
      - ShellCommand:
          command: rm -rf node_modules
      - ShellCommandWithSecrets: *aws-credentials
      - ShellCommandWithSecrets: *npm-install
      - ShellCommandWithSecrets:
          command: bash -l tests.bash
          timeout: 120
          env:
            <<: *global_env
            CIRCLE_NODE_INDEX: '1'
      - ShellCommand:
          name: prepare artifacts
          command: |
            mkdir -p artifacts/node1
            cp /tmp/*.txt artifacts/node1
      - Upload: *upload_artifacts
  node2:
    worker: *master-worker
    steps:
      - Git: *clone
      - ShellCommand: *update_hosts
      - ShellCommand:
          command: rm -rf node_modules
      - ShellCommandWithSecrets: *aws-credentials
      - ShellCommandWithSecrets: *npm-install
      - ShellCommandWithSecrets:
          command: bash -l tests.bash
          env:
            <<: *global_env
            CIRCLE_NODE_INDEX: '2'
      - ShellCommand:
          name: prepare artifacts
          command: |
            mkdir -p artifacts/node2
            cp /tmp/*.txt artifacts/node2
      - Upload: *upload_artifacts
  node3:
    worker: *master-worker
    steps:
      - Git: *clone
      - ShellCommand: *update_hosts
      - ShellCommand:
          command: rm -rf node_modules
      - ShellCommandWithSecrets: *aws-credentials
      - ShellCommandWithSecrets: *npm-install
      - ShellCommandWithSecrets:
          command: bash -l tests.bash
          timeout: 120
          env:
            <<: *global_env
            CIRCLE_NODE_INDEX: '3'
      - ShellCommand:
          name: prepare artifacts
          command: |
            mkdir -p artifacts/node3
            cp /tmp/*.txt artifacts/node3
      - Upload: *upload_artifacts
